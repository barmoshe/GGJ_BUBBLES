<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AshaHi ScreenSaver with FBX Model</title>
    <style>
      /* ======================================================
       1. Global Styles and Resets
    ====================================================== */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000; /* Overridden by chosen environment class */
        overflow: hidden;
        transition: background 1s ease; /* Smooth transition when changing backgrounds */
        position: relative;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; /* Modern and clean font */
        color: #fff; /* Default text color */
      }
      #container {
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 1; /* Ensure it stays above the animated backgrounds */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* ======================================================
       2. Environment Backgrounds
    ====================================================== */

      /* 2.1 Action: Advanced Animated Fire Effect with Multiple Layers and Enhanced Particles */
      .bg-action {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: #000;
      }

      /* Fire Layers */
      .bg-action::before,
      .bg-action::after,
      .bg-action::nth-child(3) {
        content: "";
        position: absolute;
        width: 200%;
        height: 200%;
        top: -50%;
        left: -50%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(255, 140, 0, 0.6),
          rgba(255, 87, 34, 0.4),
          rgba(255, 0, 0, 0.2)
        );
        animation: fireFlame 3s infinite ease-in-out;
        opacity: 0.5;
        mix-blend-mode: multiply;
      }

      .bg-action::after {
        animation-delay: 1.5s;
        opacity: 0.3;
      }

      .bg-action::nth-child(3) {
        animation-delay: 0.75s;
        opacity: 0.4;
      }

      @keyframes fireFlame {
        0% {
          transform: scale(1) translateY(0px);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.2) translateY(-30px);
          opacity: 0.7;
        }
        100% {
          transform: scale(1) translateY(0px);
          opacity: 0.5;
        }
      }

      /* Enhanced Particle Explosion */
      .bg-action .particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: radial-gradient(
          circle,
          rgba(255, 165, 0, 0.9) 0%,
          rgba(255, 69, 0, 0.6) 60%,
          rgba(255, 0, 0, 0) 100%
        );
        border-radius: 50%;
        opacity: 0;
        animation: particleBurst 2s infinite;
        pointer-events: none; /* Ensure particles don't interfere with UI */
      }

      @keyframes particleBurst {
        0% {
          transform: translate(0, 0) scale(1);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        100% {
          transform: translate(var(--translate-x), var(--translate-y))
            scale(0.5);
          opacity: 0;
        }
      }

      /* Additional Glow Effect */
      .bg-action .glow {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300px;
        height: 300px;
        background: radial-gradient(
          circle,
          rgba(255, 140, 0, 0.3) 0%,
          rgba(255, 87, 34, 0.1) 70%,
          rgba(255, 0, 0, 0) 100%
        );
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: glowPulse 4s infinite;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      @keyframes glowPulse {
        0%,
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.3;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.2);
          opacity: 0.6;
        }
      }

      /* 2.2 Calm: Advanced Calming Gradient with Parallax Clouds */
      .bg-calm {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: linear-gradient(120deg, #a8edea, #fed6e3);
        background-size: 400% 400%;
        animation: calmGradient 15s ease infinite;
      }

      @keyframes calmGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* Parallax Clouds */
      .bg-calm .clouds {
        position: absolute;
        top: 0;
        left: 0;
        width: 200%;
        height: 200%;
        background: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDIwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMjAiIHN0eWxlPSJmaWxsOiNmZmY7c3Ryb2tlOiMwMDA7c3Ryb2tlLXdpZHRoOjI7Ii8+PGNpcmNsZSBjeD0iMTUwIiBjeT0iNTAiIHI9IjIwIiBzdHlsZT0iZmlsbDojZmZmO3N0cm9rZTojMDAwO3N0cm9rZS13aWR0aDoyOyIvPjwvc3ZnPg==")
          repeat;
        animation: moveClouds 60s linear infinite;
        opacity: 0.3;
        transform: scale(1.5);
      }

      @keyframes moveClouds {
        from {
          transform: translateX(0) scale(1.5);
        }
        to {
          transform: translateX(-1000px) scale(1.5);
        }
      }

      /* 2.3 Scary: Enhanced Flickering with Shadow Shapes */
      .bg-scary {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: radial-gradient(
          circle at 50% 50%,
          #1a0000,
          #330000,
          #1a0000
        ); /* Deep red hues */
        animation: scaryBackgroundPulse 10s ease infinite;
      }

      @keyframes scaryBackgroundPulse {
        0%,
        100% {
          background: radial-gradient(
            circle at 50% 50%,
            #1a0000,
            #330000,
            #1a0000
          );
        }
        50% {
          background: radial-gradient(
            circle at 50% 50%,
            #330000,
            #1a0000,
            #330000
          );
        }
      }

      .bg-scary::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle,
          rgba(255, 0, 0, 0.5),
          rgba(0, 100, 0, 0.3)
        );
        opacity: 0.7; /* Increased opacity for a denser look */
        animation: scaryFlicker 3s infinite;
        mix-blend-mode: overlay;
      }

      @keyframes scaryFlicker {
        0%,
        100% {
          opacity: 0.7;
        }
        25%,
        75% {
          opacity: 0.9;
        }
        50% {
          opacity: 1;
        }
      }

      /* Enhanced Shadow Shapes */
      .bg-scary .shadow {
        position: absolute;
        width: 80px; /* Reduced size for more shadows */
        height: 80px;
        background: rgba(0, 0, 0, 0.5); /* Darker shadows */
        border-radius: 50%;
        top: 20%;
        left: 30%;
        filter: blur(30px); /* Increased blur for a ghostly effect */
        animation: moveShadow 8s infinite alternate;
      }

      .bg-scary .shadow::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: inherit;
        border-radius: inherit;
        animation: scaleShadow 8s infinite alternate;
      }

      @keyframes moveShadow {
        from {
          transform: translate(0, 0);
        }
        to {
          transform: translate(150px, -150px);
        }
      }

      @keyframes scaleShadow {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.3);
        }
      }

      /* Additional Eerie Elements */
      .bg-scary .eerie-mist {
        position: absolute;
        width: 100%;
        height: 100%;
        background: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjUwIiB2aWV3Qm94PSIwIDAgMTAwIDUwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0wIDUwQzIwLjg3NyA1MCAzMi43NjMgNDYuNTY5IDQ0LjIzOSA0MCA1NS44NTMgMzEuNDY3IDM3LjQ4OCAxMjQuNjk5IDM3LjQ4OCAxMjQuNjk5QzM3LjQ4OCAxMjQuNjk5IDc1LjA4OSA0Ny4zMTMgNzUuMDg5IDQ3LjMxM0M3NS4wODkgNDcuMzEzIDk4LjI0OCA0Ni41NjkgMTAwIDUwWiIgZmlsbD0iI2ZmZiIgLz48L3N2Zz4=");
        opacity: 0.3;
        animation: mistMove 10s linear infinite;
        pointer-events: none;
      }

      @keyframes mistMove {
        from {
          transform: translateX(-100px) translateY(-50px) scale(1);
          opacity: 0.3;
        }
        to {
          transform: translateX(100px) translateY(-150px) scale(1.2);
          opacity: 0.1;
        }
      }

      /* 2.4 Void: Enhanced Voidish Vibes */
      .bg-void {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: radial-gradient(
          circle at 20% 20%,
          #1a1a2e,
          #16213e,
          #0f3460,
          #0f2027
        );
        /* Deep space colors */
        animation: voidGradient 20s ease infinite;
      }

      @keyframes voidGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* Starfield Background */
      .bg-void::before {
        content: "";
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(white 1px, transparent 1px),
          radial-gradient(white 1px, transparent 1px);
        background-size: 3px 3px;
        animation: starfieldMove 60s linear infinite;
        opacity: 0.8; /* Increased opacity for more stars */
      }

      @keyframes starfieldMove {
        from {
          background-position: 0 0, 0 0;
        }
        to {
          background-position: 100px 100px, -100px 100px;
        }
      }

      /* Shooting Stars */
      .bg-void .shooting-star {
        position: absolute;
        width: 2px;
        height: 150px; /* Longer shooting stars for a more dramatic effect */
        background: linear-gradient(white, rgba(255, 255, 255, 0));
        top: 0;
        left: 0;
        opacity: 0;
        transform: rotate(45deg);
        animation: shootingStar 7s infinite;
      }

      @keyframes shootingStar {
        0% {
          transform: translate(0, 0) rotate(45deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        20% {
          transform: translate(700px, 700px) rotate(45deg);
          opacity: 0;
        }
        100% {
          opacity: 0;
        }
      }

      /* ======================================================
       3. Overlay for Environment Selection
    ====================================================== */
      #audioChoiceOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(
          0,
          0,
          0,
          0.85
        ); /* Darker overlay for better contrast */
        color: #fff;
        font-size: 1.2em;
        text-align: center;
        z-index: 999999;
        transition: opacity 0.5s ease, visibility 0.5s ease;
      }
      #audioChoiceOverlay.hidden {
        opacity: 0;
        visibility: hidden;
      }
      #audioChoiceOverlay .panel {
        display: flex;
        flex-direction: column;
        gap: 24px; /* Increased gap for better spacing */
        padding: 32px 40px; /* Increased padding for spaciousness */
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px; /* More pronounced border radius */
        width: 400px;
        max-width: 90%;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5); /* Enhanced shadow for depth */
      }
      #audioChoiceOverlay button {
        cursor: pointer;
        font-size: 16px;
        padding: 14px 24px; /* Increased padding for better touch targets */
        border: none;
        border-radius: 8px; /* Rounded corners */
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        transition: background 0.3s ease, transform 0.2s ease;
        width: 100%;
        max-width: 220px;
        align-self: center;
        font-weight: bold; /* Bold text for emphasis */
      }
      #audioChoiceOverlay button:hover,
      #audioChoiceOverlay button:focus {
        background: rgba(0, 0, 0, 0.7);
        transform: scale(1.05); /* Subtle scaling on hover */
        outline: none; /* Remove default outline */
      }

      /* ======================================================
       4. Bottom-Right Controls Panel
    ====================================================== */
      #controlsOverlay {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-wrap: wrap; /* Allows wrapping on smaller screens */
        align-items: center;
        gap: 16px;
        background: rgba(
          0,
          0,
          0,
          0.5
        ); /* Darker background for better contrast */
        padding: 14px 20px;
        border-radius: 10px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); /* Enhanced shadow for depth */
      }
      /* Shared button style */
      .button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        font-size: 16px;
        padding: 12px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
      .button:hover,
      .button:focus {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.05); /* Subtle scaling on hover */
        outline: none; /* Remove default outline */
      }
      #muteBtn span {
        font-size: 20px; /* Larger icon for better visibility */
      }

      /* ======================================================
       5. Responsive Design Enhancements
    ====================================================== */
      /* Mobile Styles */
      @media screen and (max-width: 768px) {
        #controlsOverlay {
          bottom: 10px;
          right: 10px;
          padding: 10px 16px;
          gap: 12px;
        }
        .button {
          font-size: 14px;
          padding: 10px 16px;
        }
        #muteBtn span {
          font-size: 18px;
        }
        /* Adjust environment overlay for smaller screens */
        #audioChoiceOverlay .panel {
          padding: 20px 24px;
          gap: 20px;
        }
        #audioChoiceOverlay button {
          padding: 10px 16px;
          font-size: 14px;
          max-width: 180px;
        }
        #audioChoiceOverlay p {
          font-size: 1em;
        }
      }

      /* Accessibility: Reduced Motion */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="container">
      <!-- Three.js Canvas is appended here -->
    </div>

    <!-- Fullscreen overlay for environment choice -->
    <div id="audioChoiceOverlay">
      <div class="panel">
        <p style="margin: 0; font-size: 1.3em">Pick Your Environment:</p>
        <div
          style="
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
          "
        >
          <button id="envActionBtn">Action</button>
          <button id="envCalmBtn">Calm</button>
          <button id="envScaryBtn">Scary</button>
          <button id="envVoidBtn">Void</button>
        </div>
        <p style="font-size: 1em; opacity: 0.8; margin-top: 12px">
          (Recommended with audio)
        </p>
      </div>
    </div>
    <div id="controlsOverlay">
      <button id="changeEnvBtn" class="button">Change Environment</button>
      <button id="changeFbxBtn" class="button">
        <span>🔄</span>
        <span>Change Model</span>
      </button>
      <button id="muteBtn" class="button" aria-label="Mute or Unmute Audio">
        <span id="muteIcon">🔊</span>
        <span id="muteLabel">Mute</span>
      </button>
    </div>

    <script src="
https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js
"></script>

    <!-- Three.js (r128 for FBXLoader compatibility) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- FBXLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <!-- Inflate (required by FBXLoader for compressed files) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/inflate.min.js"></script>

    <script>
      /* ======================================================
       1. Global Variables
    ====================================================== */
      let scene, camera, renderer, model, mixer;
      let velocity = new THREE.Vector2(0.05, 0.05); // Reduced speed to prevent frequent bounces
      // Removed spinDirection as FBX animations may handle rotation
      // let spinDirection = new THREE.Vector3(0.02, 0.02, 0.02);

      const BASE_HALF_HEIGHT = 30;
      const MODEL_RADIUS = 10; // Increased to accommodate larger model

      let currentBgAudio = null; // HTMLAudio for background
      let muted = false;

      // Web Audio for bounce SFX
      let audioCtx = null;
      let bounceBuffers = [];
      const bounceSFX = ["fall1.wav", "fall2.wav", "fall3.wav"]; // Ensure these files are correctly placed

      /* Our environments: class + optional music track */
      const environments = {
        Action: {
          bgClass: "bg-action",
          music: "bg_music2.wav", // Ensure this file is correctly placed
          speed: 0.65, // Faster speed for Action
        },
        Calm: {
          bgClass: "bg-calm",
          music: "BG_loop.wav", // Ensure this file is correctly placed
          speed: 0.2, // Slower speed for Calm
        },
        Scary: {
          bgClass: "bg-scary",
          music: "33.wav", // Ensure this file is correctly placed
          speed: null, // Speed handled dynamically for Scary
        },
        Void: {
          bgClass: "bg-void",
          music: null, // No background music for Void
          speed: 0.0, // Default speed for Void
        },
      };

      /* ======================================================
       2. Speed Scaling Based on Screen Width
    ====================================================== */
      function getSpeedScale() {
        const baseWidth = 1920;
        const minScale = 0.4;
        const maxScale = 1.0;
        const currentWidth = window.innerWidth;
        const scale = Math.min(
          Math.max(currentWidth / baseWidth, minScale),
          maxScale
        );
        return scale;
      }

      let previousScale = getSpeedScale();

      /* ======================================================
       3. Environment Selection
    ====================================================== */
      document
        .getElementById("envActionBtn")
        .addEventListener("click", () => pickEnvironment("Action"));
      document
        .getElementById("envCalmBtn")
        .addEventListener("click", () => pickEnvironment("Calm"));
      document
        .getElementById("envScaryBtn")
        .addEventListener("click", () => pickEnvironment("Scary"));
      document
        .getElementById("envVoidBtn")
        .addEventListener("click", () => pickEnvironment("Void"));

      let speedIntervalId = null; // To manage speed changes in Scary environment

      async function pickEnvironment(envKey) {
        const env = environments[envKey];
        if (!env) return;

        // 1. Stop current background audio
        stopCurrentBG();

        // 2. Remove existing environment classes
        document.body.classList.remove(
          ...Object.values(environments).map((e) => e.bgClass)
        );

        // 3. Add new environment class
        document.body.classList.add(env.bgClass);

        // 4. Play new background music if available
        if (env.music) {
          currentBgAudio = new Audio(env.music);
          currentBgAudio.loop = true;
          currentBgAudio.volume = 0.5;
          currentBgAudio.muted = muted;
          currentBgAudio.setAttribute("playsinline", ""); // For iOS
          try {
            await currentBgAudio.play();
          } catch (err) {
            console.warn("Audio play blocked:", err);
          }
        } else {
          // "Void" => no background track
          currentBgAudio = null;
        }

        // 5. Initialize Web Audio for bounce SFX if not done
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          loadBounceSFX();
        }

        // 6. Hide environment selection overlay
        hideEnvironmentOverlay();

        // 7. Add environment-specific dynamic elements
        addDynamicElements(envKey);

        // 8. Adjust speed based on environment
        if (envKey === "Scary") {
          // Handle Scary environment speed separately
          startScarySpeedChanges();
        } else {
          // Clear any existing speed intervals
          if (speedIntervalId) {
            clearInterval(speedIntervalId);
            speedIntervalId = null;
          }
          setEnvironmentSpeed(env.speed);
        }
      }

      function stopCurrentBG() {
        if (currentBgAudio) {
          currentBgAudio.pause();
          currentBgAudio.src = ""; // Release the audio element
          currentBgAudio = null;
        }

        // Remove dynamic elements specific to the previous environment
        removeDynamicElements();

        // Clear any existing speed intervals
        if (speedIntervalId) {
          clearInterval(speedIntervalId);
          speedIntervalId = null;
        }
      }

      function hideEnvironmentOverlay() {
        const overlay = document.getElementById("audioChoiceOverlay");
        if (overlay) {
          overlay.classList.add("hidden");
          setTimeout(() => {
            overlay.style.display = "none";
          }, 500); // Match the CSS transition duration
        }
      }

      /* Pre-fetch & decode bounce SFX into AudioBuffers */
      async function loadBounceSFX() {
        const buffers = [];
        for (const url of bounceSFX) {
          try {
            const resp = await fetch(url);
            const arrayBuf = await resp.arrayBuffer();
            const audioBuf = await audioCtx.decodeAudioData(arrayBuf);
            buffers.push(audioBuf);
          } catch (e) {
            console.warn("Error decoding bounce SFX:", url, e);
          }
        }
        bounceBuffers = buffers;
      }

      /* ======================================================
       4. "Change Environment" Button
    ====================================================== */
      document.getElementById("changeEnvBtn").addEventListener("click", () => {
        showEnvironmentOverlay();
      });

      function showEnvironmentOverlay() {
        const overlay = document.getElementById("audioChoiceOverlay");
        if (overlay) {
          overlay.style.display = "flex";
          overlay.classList.remove("hidden");
        }
      }

      /* ======================================================
       5. Mute / Unmute Functionality
    ====================================================== */
      document.getElementById("muteBtn").addEventListener("click", () => {
        muted = !muted;
        if (currentBgAudio) {
          currentBgAudio.muted = muted;
        }
        updateMuteUI();
      });

      function updateMuteUI() {
        const muteIcon = document.getElementById("muteIcon");
        const muteLabel = document.getElementById("muteLabel");
        if (muted) {
          muteIcon.textContent = "🔇";
          muteLabel.textContent = "Unmute";
        } else {
          muteIcon.textContent = "🔊";
          muteLabel.textContent = "Mute";
        }
      }

      /* ======================================================
       6. Dynamic Speed Adjustment Based on Environment
    ====================================================== */
      function setEnvironmentSpeed(envSpeed) {
        const scale = getSpeedScale();
        velocity.set(envSpeed * scale, envSpeed * scale);
      }

      /* Function to start random speed changes for Scary environment */
      function startScarySpeedChanges() {
        // Clear any existing interval just in case
        if (speedIntervalId) {
          clearInterval(speedIntervalId);
        }

        // Initial random speed
        setRandomVelocity();

        // Set interval to change speed every 0.2 seconds
        speedIntervalId = setInterval(setRandomVelocity, 200);
      }

      /* Function to set random velocity */
      function setRandomVelocity() {
        const minSpeed = -1.0;
        const maxSpeed = 1.0;
        const randomX = Math.random() * (maxSpeed - minSpeed) + minSpeed;
        const randomY = Math.random() * (maxSpeed - minSpeed) + minSpeed;
        const scale = getSpeedScale();
        velocity.set(randomX * scale, randomY * scale);
      }
      const clock = new THREE.Clock();
      let currentModelIndex = -1; // Track current model
const animationPaths = [
    "BreakdanceFootworkToIdle.fbx",
    "Capoeira.fbx",
    "JoyfulJump.fbx",
    "DancingTwerk.fbx",
    "Shuffling.fbx",
    "SillyDancing.fbx",
    "Spinning.fbx",
    "SittingDisbelief.fbx",
    "Flair.fbx",
    "WaveHipHopDance.fbx",
    "HipHopDancing.fbx"
];

      /* ======================================================
       7. Three.js Setup (with alpha => transparent background)
    ====================================================== */
    let currentModelColor = new THREE.Color(0xffffff); // Default white color

    // Add this function to handle model loading
    function loadRandomFBX(previousPosition = null) {
    // Get a new random index different from the current one
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * animationPaths.length);
    } while (newIndex === currentModelIndex && animationPaths.length > 1);
    
    currentModelIndex = newIndex;
    const modelPath = animationPaths[currentModelIndex];

    const loader = new THREE.FBXLoader();
    loader.load(
        modelPath,
        (fbx) => {
            if (model) {
                // Store the current position if not provided
                if (!previousPosition) {
                    previousPosition = model.position.clone();
                }
                
                // Store the current color before removing the old model
                model.traverse((child) => {
                    if (child.isMesh && child.material && child.material.color) {
                        currentModelColor = child.material.color.clone();
                        return; // Exit after getting the first mesh's color
                    }
                });
                
                // Clean up old model
                scene.remove(model);
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.geometry.dispose();
                        child.material.dispose();
                    }
                });
            }

            model = fbx;
            model.scale.set(1, 1, 1);
            
            // Set position to previous model's position or default
            if (previousPosition) {
                model.position.copy(previousPosition);
            } else {
                model.position.set(0, 0, 0);
            }
            
            // Apply the stored color to the new model
            model.traverse((child) => {
                if (child.isMesh) {
                    if (Array.isArray(child.material)) {
                        // Handle multi-material meshes
                        child.material.forEach(mat => {
                            mat.color = currentModelColor.clone();
                        });
                    } else {
                        // Single material mesh
                        child.material.color = currentModelColor.clone();
                    }
                }
            });
            
            scene.add(model);

            // Setup animation mixer
            if (mixer) {
                mixer.stopAllAction();
                mixer.uncacheRoot(mixer.getRoot());
            }
            mixer = new THREE.AnimationMixer(model);
            
            if (fbx.animations && fbx.animations.length > 0) {
                fbx.animations.forEach((clip) => {
                    mixer.clipAction(clip).play();
                });
            } else {
                console.warn("No animations found in the FBX model:", modelPath);
            }
        },
        (xhr) => {
            console.log(`${modelPath}: ${((xhr.loaded / xhr.total) * 100).toFixed(1)}% loaded`);
        },
        (error) => {
            console.error("Error loading FBX model:", error);
        }
    );
}

      initThree();
      animate(); // Start the animation loop

      /* Initialize Clock Outside Animate Loop */

      function initThree() {
        scene = new THREE.Scene();

        const w = window.innerWidth;
        const h = window.innerHeight;
        const aspect = w / h;

        camera = new THREE.OrthographicCamera(
          -BASE_HALF_HEIGHT * aspect,
          BASE_HALF_HEIGHT * aspect,
          BASE_HALF_HEIGHT,
          -BASE_HALF_HEIGHT,
          1,
          1000
        );
        camera.position.set(0, 0, 100); // Adjusted to center the model
        camera.lookAt(0, 0, 0);

        // Transparent renderer so body background is visible
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setClearColor(0x000000, 0);
        renderer.setSize(w, h);
        document.getElementById("container").appendChild(renderer.domElement);

        // **3.1 Remove OrbitControls to Lock Viewport**
        // OrbitControls are removed to prevent user interaction
 
        loadRandomFBX();

        // **3.4 Lights**
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 1);
        directional.position.set(1, 2, 3);
        scene.add(directional);

        window.addEventListener("resize", onWindowResize);
      }

      function onWindowResize() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        renderer.setSize(w, h);

        const aspect = w / h;
        camera.left = -BASE_HALF_HEIGHT * aspect;
        camera.right = BASE_HALF_HEIGHT * aspect;
        camera.top = BASE_HALF_HEIGHT;
        camera.bottom = -BASE_HALF_HEIGHT;
        camera.updateProjectionMatrix();

        // Adjust velocity scale
        adjustCurrentVelocityScale();
      }

      /* ======================================================
       8. Main Animation Loop
    ====================================================== */
      function animate() {
        requestAnimationFrame(animate);

        const delta = clock.getDelta();

        if (mixer) mixer.update(delta); // Update animations

        if (model) {
          // Move
          model.position.x += velocity.x;
          model.position.y += velocity.y;

          // Bounce boundary
          const { halfW, halfH } = getCurrentBounceBox();
          let bounced = false;

          if (model.position.x > halfW) {
            model.position.x = halfW;
            velocity.x *= -1;
            bounced = true;
          } else if (model.position.x < -halfW) {
            model.position.x = -halfW;
            velocity.x *= -1;
            bounced = true;
          }

          if (model.position.y > halfH) {
            model.position.y = halfH;
            velocity.y *= -1;
            bounced = true;
          } else if (model.position.y < -halfH) {
            model.position.y = -halfH;
            velocity.y *= -1;
            bounced = true;
          }

          if (bounced) {
            onBounce();
          }

          /* 
           Removed spin updates to prevent unnecessary rotations that might cause
           boundary collisions. If you still want the model to spin, consider limiting
           the spin speed or ensuring it doesn't affect position-based collisions.
        */
          /*
        // Spin (optional, can be removed if not needed)
        model.rotation.x += spinDirection.x;
        model.rotation.y += spinDirection.y;
        model.rotation.z += spinDirection.z;
        */
        }

        renderer.render(scene, camera);
      }

      function getCurrentBounceBox() {
        // Define boundaries based on camera view
        const halfH = BASE_HALF_HEIGHT / camera.zoom - MODEL_RADIUS;
        const halfW = halfH * (window.innerWidth / window.innerHeight);
        return { halfW, halfH };
      }

      /* ======================================================
       9. Bouncing Logic
    ====================================================== */
    function onBounce() {
    if (!model) return;

    // Generate new random color
    const randColor = new THREE.Color(Math.random() * 0xffffff);
    
    // Store the new color
    currentModelColor = randColor.clone();
    
    // Apply the new color to all mesh materials
    model.traverse((child) => {
        if (child.isMesh && child.material) {
            if (Array.isArray(child.material)) {
                // Handle multi-material meshes
                child.material.forEach(mat => {
                    mat.color.copy(currentModelColor);
                });
            } else {
                // Single material mesh
                child.material.color.copy(currentModelColor);
            }
        }
    });

    // Play bounce sound if not muted
    playBounceSound();
}

      function playBounceSound() {
        if (muted || !audioCtx || bounceBuffers.length === 0) return;

        const index = Math.floor(Math.random() * bounceBuffers.length);
        const buf = bounceBuffers[index];
        if (!buf) return;

        const source = audioCtx.createBufferSource();
        source.buffer = buf;
        source.connect(audioCtx.destination);
        source.start(0);
      }

      /* ======================================================
       10. Dynamic Elements Management
    ====================================================== */
      let dynamicElements = [];

      function addDynamicElements(envKey) {
        switch (envKey) {
          case "Action":
            addActionParticles();
            break;
          case "Calm":
            addCalmClouds();
            break;
          case "Scary":
            addScaryShadows();
            addEerieMist(); // Added mist for more depth
            break;
          case "Void":
            addShootingStars();
            break;
          default:
            break;
        }
      }

      function removeDynamicElements() {
        dynamicElements.forEach((el) => el.remove());
        dynamicElements = [];
      }

      /* 10.1 Action: Enhanced Particle Explosion */
      function addActionParticles() {
        const bgAction = document.querySelector(".bg-action");
        if (!bgAction) return;

        for (let i = 0; i < 30; i++) {
          // Increased number of particles
          const particle = document.createElement("div");
          particle.classList.add("particle");
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.top = `${Math.random() * 100}%`;
          particle.style.setProperty(
            "--translate-x",
            `${Math.random() * 500 - 250}px`
          );
          particle.style.setProperty(
            "--translate-y",
            `${-(Math.random() * 500)}px`
          );
          particle.style.animationDelay = `${Math.random() * 5}s`;
          particle.style.animationDuration = `${2 + Math.random() * 3}s`;
          bgAction.appendChild(particle);
          dynamicElements.push(particle);
        }

        // Add Glow Effect
        const glow = document.createElement("div");
        glow.classList.add("glow");
        bgAction.appendChild(glow);
        dynamicElements.push(glow);
      }

      /* 10.2 Calm: Parallax Clouds */
      function addCalmClouds() {
        const bgCalm = document.querySelector(".bg-calm");
        if (!bgCalm) return;

        const clouds = document.createElement("div");
        clouds.classList.add("clouds");
        bgCalm.appendChild(clouds);
        dynamicElements.push(clouds);
      }

      /* 10.3 Scary: Enhanced Shadow Shapes */
      function addScaryShadows() {
        const bgScary = document.querySelector(".bg-scary");
        if (!bgScary) return;

        for (let i = 0; i < 8; i++) {
          // Increased number of shadows
          const shadow = document.createElement("div");
          shadow.classList.add("shadow");
          shadow.style.left = `${Math.random() * 100}%`;
          shadow.style.top = `${Math.random() * 100}%`;
          shadow.style.animationDuration = `${8 + Math.random() * 12}s`; // Varied animation durations
          bgScary.appendChild(shadow);
          dynamicElements.push(shadow);
        }
      }

      /* 10.4 Void: Enhanced Shooting Stars for More Voidish Vibes */
      function addShootingStars() {
        const bgVoid = document.querySelector(".bg-void");
        if (!bgVoid) return;

        for (let i = 0; i < 5; i++) {
          // Increased number for more dynamic effect
          const shootingStar = document.createElement("div");
          shootingStar.classList.add("shooting-star");
          shootingStar.style.left = `${Math.random() * 100}%`;
          shootingStar.style.animationDelay = `${Math.random() * 15}s`; // Spread out shooting stars
          shootingStar.style.animationDuration = `7s`; // Consistent duration for realism
          bgVoid.appendChild(shootingStar);
          dynamicElements.push(shootingStar);
        }
      }

      /* 10.5 Scary: Add Eerie Mist */
      function addEerieMist() {
        const bgScary = document.querySelector(".bg-scary");
        if (!bgScary) return;

        const mist = document.createElement("div");
        mist.classList.add("eerie-mist");
        bgScary.appendChild(mist);
        dynamicElements.push(mist);
      }

      /* ======================================================
       11. Adjust Velocity Scale on Window Resize
    ====================================================== */
      function adjustCurrentVelocityScale() {
        const scale = getSpeedScale();
        velocity.set(
          (velocity.x / previousScale) * scale,
          (velocity.y / previousScale) * scale
        );
        previousScale = scale;
      }

      /* ======================================================
       12. Initialize with Default Environment
    ====================================================== */
    // Add event listener for the new button
document.addEventListener('DOMContentLoaded', () => {
    const changeFbxBtn = document.getElementById('changeFbxBtn');
    if (changeFbxBtn) {
        changeFbxBtn.addEventListener('click', () => {
            if (model) {
                const currentPosition = model.position.clone();
                loadRandomFBX(currentPosition);
            } else {
                loadRandomFBX();

            }
        });
    }
});
      document.addEventListener("DOMContentLoaded", () => {
        // Set a default environment, e.g., "Void"
        pickEnvironment("Void");
      });
    </script>
  </body>
</html>
