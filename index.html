<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Ensure proper scaling on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AshaHi ScreenSaver with FBX Model - Improved</title>
    <style>
      /* ======================================================
       1. Global Styles and Resets
      ====================================================== */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        overflow: hidden;
        transition: background 1s ease;
        position: relative;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #fff;
      }
      #container {
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* ======================================================
       2. Environment Backgrounds
      ====================================================== */

      /* 2.1 Action: Advanced Animated Fire Effect */
      .bg-action {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: #000;
      }
      /* Two pseudoâ€“elements for two fire layers */
      .bg-action::before,
      .bg-action::after {
        content: "";
        position: absolute;
        width: 200%;
        height: 200%;
        top: -50%;
        left: -50%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(255, 140, 0, 0.6),
          rgba(255, 87, 34, 0.4),
          rgba(255, 0, 0, 0.2)
        );
        animation: fireFlame 3s infinite ease-in-out;
        opacity: 0.5;
        mix-blend-mode: multiply;
      }
      .bg-action::after {
        animation-delay: 1.5s;
        opacity: 0.3;
      }
      /* Third fire layer added via element (see addActionParticles) */
      .bg-action .fire-layer {
        position: absolute;
        width: 200%;
        height: 200%;
        top: -50%;
        left: -50%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(255, 140, 0, 0.6),
          rgba(255, 87, 34, 0.4),
          rgba(255, 0, 0, 0.2)
        );
        animation: fireFlame 3s infinite ease-in-out;
        opacity: 0.4;
        mix-blend-mode: multiply;
        animation-delay: 0.75s;
      }
      @keyframes fireFlame {
        0% {
          transform: scale(1) translateY(0px);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.2) translateY(-30px);
          opacity: 0.7;
        }
        100% {
          transform: scale(1) translateY(0px);
          opacity: 0.5;
        }
      }

      /* Enhanced Particle Explosion */
      .bg-action .particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: radial-gradient(
          circle,
          rgba(255, 165, 0, 0.9) 0%,
          rgba(255, 69, 0, 0.6) 60%,
          rgba(255, 0, 0, 0) 100%
        );
        border-radius: 50%;
        opacity: 0;
        animation: particleBurst 2s infinite;
        pointer-events: none;
      }
      @keyframes particleBurst {
        0% {
          transform: translate(0, 0) scale(1);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        100% {
          transform: translate(var(--translate-x), var(--translate-y)) scale(0.5);
          opacity: 0;
        }
      }

      /* Additional Glow Effect */
      .bg-action .glow {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300px;
        height: 300px;
        background: radial-gradient(
          circle,
          rgba(255, 140, 0, 0.3) 0%,
          rgba(255, 87, 34, 0.1) 70%,
          rgba(255, 0, 0, 0) 100%
        );
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: glowPulse 4s infinite;
        mix-blend-mode: screen;
        pointer-events: none;
      }
      @keyframes glowPulse {
        0%,
        100% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.3;
        }
        50% {
          transform: translate(-50%, -50%) scale(1.2);
          opacity: 0.6;
        }
      }

      /* 2.2 Calm: Advanced Calming Gradient with Parallax Clouds */
      .bg-calm {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: linear-gradient(120deg, #a8edea, #fed6e3);
        background-size: 400% 400%;
        animation: calmGradient 15s ease infinite;
      }
      @keyframes calmGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .bg-calm .clouds {
        position: absolute;
        top: 0;
        left: 0;
        width: 200%;
        height: 200%;
        background: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDIwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMjAiIHN0eWxlPSJmaWxsOiNmZmY7c3Ryb2tlOiMwMDA7c3Ryb2tlLXdpZHRoOjI7Ii8+PGNpcmNsZSBjeD0iMTUwIiBjeT0iNTAiIHI9IjIwIiBzdHlsZT0iZmlsbDojZmZmO3N0cm9rZTojMDAwO3N0cm9rZS13aWR0aDoyOyIvPjwvc3ZnPg==")
          repeat;
        animation: moveClouds 60s linear infinite;
        opacity: 0.3;
        transform: scale(1.5);
      }
      @keyframes moveClouds {
        from {
          transform: translateX(0) scale(1.5);
        }
        to {
          transform: translateX(-1000px) scale(1.5);
        }
      }

      /* 2.3 Scary: Enhanced Flickering with Shadow Shapes and Eerie Mist */
      .bg-scary {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: radial-gradient(
          circle at 50% 50%,
          #1a0000,
          #330000,
          #1a0000
        );
        animation: scaryBackgroundPulse 10s ease infinite;
      }
      @keyframes scaryBackgroundPulse {
        0%,
        100% {
          background: radial-gradient(
            circle at 50% 50%,
            #1a0000,
            #330000,
            #1a0000
          );
        }
        50% {
          background: radial-gradient(
            circle at 50% 50%,
            #330000,
            #1a0000,
            #330000
          );
        }
      }
      .bg-scary::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle,
          rgba(255, 0, 0, 0.5),
          rgba(0, 100, 0, 0.3)
        );
        opacity: 0.7;
        animation: scaryFlicker 3s infinite;
        mix-blend-mode: overlay;
      }
      @keyframes scaryFlicker {
        0%,
        100% {
          opacity: 0.7;
        }
        25%,
        75% {
          opacity: 0.9;
        }
        50% {
          opacity: 1;
        }
      }
      .bg-scary .shadow {
        position: absolute;
        width: 80px;
        height: 80px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        top: 20%;
        left: 30%;
        filter: blur(30px);
        animation: moveShadow 8s infinite alternate;
      }
      .bg-scary .shadow::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: inherit;
        border-radius: inherit;
        animation: scaleShadow 8s infinite alternate;
      }
      @keyframes moveShadow {
        from {
          transform: translate(0, 0);
        }
        to {
          transform: translate(150px, -150px);
        }
      }
      @keyframes scaleShadow {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.3);
        }
      }
      .bg-scary .eerie-mist {
        position: absolute;
        width: 100%;
        height: 100%;
        background: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjUwIiB2aWV3Qm94PSIwIDAgMTAwIDUwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0wIDUwQzIwLjg3NyA1MCAzMi43NjMgNDYuNTY5IDQ0LjIzOSA0MCA1NS44NTMgMzEuNDY3IDM3LjQ4OCAxMjQuNjk5IDM3LjQ4OCAxMjQuNjk5QzM3LjQ4OCAxMjQuNjk5IDc1LjA4OSA0Ny4zMTMgNzUuMDg5IDQ3LjMxM0M3NS4wODkgNDcuMzEzIDk4LjI0OCA0Ni41NjkgMTAwIDUwWiIgZmlsbD0iI2ZmZiIgLz48L3N2Zz4=")
          no-repeat center center;
        opacity: 0.3;
        animation: mistMove 10s linear infinite;
        pointer-events: none;
      }
      @keyframes mistMove {
        from {
          transform: translateX(-100px) translateY(-50px) scale(1);
          opacity: 0.3;
        }
        to {
          transform: translateX(100px) translateY(-150px) scale(1.2);
          opacity: 0.1;
        }
      }

      /* 2.4 Void: Enhanced Voidish Vibes with Starfield */
      .bg-void {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        background: radial-gradient(
          circle at 20% 20%,
          #1a1a2e,
          #16213e,
          #0f3460,
          #0f2027
        );
        animation: voidGradient 20s ease infinite;
      }
      @keyframes voidGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .bg-void::before {
        content: "";
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(white 1px, transparent 1px),
          radial-gradient(white 1px, transparent 1px);
        background-size: 3px 3px;
        animation: starfieldMove 60s linear infinite;
        opacity: 0.8;
      }
      @keyframes starfieldMove {
        from {
          background-position: 0 0, 0 0;
        }
        to {
          background-position: 100px 100px, -100px 100px;
        }
      }
      .bg-void .shooting-star {
        position: absolute;
        width: 2px;
        height: 150px;
        background: linear-gradient(white, rgba(255, 255, 255, 0));
        top: 0;
        left: 0;
        opacity: 0;
        transform: rotate(45deg);
        animation: shootingStar 7s infinite;
      }
      @keyframes shootingStar {
        0% {
          transform: translate(0, 0) rotate(45deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        20% {
          transform: translate(700px, 700px) rotate(45deg);
          opacity: 0;
        }
        100% {
          opacity: 0;
        }
      }

      /* ======================================================
       3. Overlay for Environment Selection
      ====================================================== */
      #audioChoiceOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        font-size: 1.2em;
        text-align: center;
        z-index: 999999;
        transition: opacity 0.5s ease, visibility 0.5s ease;
      }
      #audioChoiceOverlay.hidden {
        opacity: 0;
        visibility: hidden;
      }
      #audioChoiceOverlay .panel {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 32px 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      }
      #audioChoiceOverlay button {
        cursor: pointer;
        font-size: 16px;
        padding: 14px 24px;
        border: none;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        transition: background 0.3s ease, transform 0.2s ease;
        width: 100%;
        max-width: 220px;
        align-self: center;
        font-weight: bold;
      }
      #audioChoiceOverlay button:hover,
      #audioChoiceOverlay button:focus {
        background: rgba(0, 0, 0, 0.7);
        transform: scale(1.05);
        outline: none;
      }

      /* ======================================================
       4. Bottom-Right Controls Panel
      ====================================================== */
      #controlsOverlay {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        background: rgba(0, 0, 0, 0.5);
        padding: 14px 20px;
        border-radius: 10px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      .button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        font-size: 16px;
        padding: 12px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
      .button:hover,
      .button:focus {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.05);
        outline: none;
      }
      #muteBtn span {
        font-size: 20px;
      }

      /* ======================================================
       5. Responsive Design Enhancements
      ====================================================== */
      @media screen and (max-width: 768px) {
        #controlsOverlay {
          bottom: 10px;
          right: 10px;
          padding: 10px 16px;
          gap: 12px;
        }
        .button {
          font-size: 14px;
          padding: 10px 16px;
        }
        #muteBtn span {
          font-size: 18px;
        }
        #audioChoiceOverlay .panel {
          padding: 20px 24px;
          gap: 20px;
        }
        #audioChoiceOverlay button {
          padding: 10px 16px;
          font-size: 14px;
          max-width: 180px;
        }
        #audioChoiceOverlay p {
          font-size: 1em;
        }
      }

      /* Accessibility: Reduced Motion */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="container">
      <!-- Three.js Canvas is appended here -->
    </div>

    <!-- Fullscreen overlay for environment choice -->
    <div id="audioChoiceOverlay">
      <div class="panel">
        <p style="margin: 0; font-size: 1.3em;">Pick Your Environment:</p>
        <div
          style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;"
        >
          <button id="envActionBtn">Action</button>
          <button id="envCalmBtn">Calm</button>
          <button id="envScaryBtn">Scary</button>
          <button id="envVoidBtn">Void</button>
        </div>
        <p style="font-size: 1em; opacity: 0.8; margin-top: 12px">
          (Recommended with audio)
        </p>
      </div>
    </div>
    <!-- Bottom-right controls panel -->
    <div id="controlsOverlay">
      <button id="changeEnvBtn" class="button">Change Environment</button>
      <button id="changeFbxBtn" class="button">
        <span>ðŸ”„</span>
        <span>Change Animation</span>
      </button>
      <button id="muteBtn" class="button" aria-label="Mute or Unmute Audio">
        <span id="muteIcon">ðŸ”Š</span>
        <span id="muteLabel">Mute</span>
      </button>
    </div>

    <!-- ======================================================
         External Libraries
    ====================================================== -->
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/inflate.min.js"></script>

    <script>
      /* ======================================================
       1. Global Variables
      ====================================================== */
      let scene, camera, renderer, model, mixer;
      let velocity = new THREE.Vector2(0.05, 0.05);
      const BASE_HALF_HEIGHT = 30;
      const MODEL_RADIUS = 10;
      let currentBgAudio = null;
      let muted = false;
      let audioCtx = null;
      let bounceBuffers = [];
      const bounceSFX = ["fall1.wav", "fall2.wav", "fall3.wav"];

      // Our environment configurations
      const environments = {
        Action: {
          bgClass: "bg-action",
          music: "bg_music2.wav",
          speed: 0.65,
        },
        Calm: {
          bgClass: "bg-calm",
          music: "BG_loop.wav",
          speed: 0.2,
        },
        Scary: {
          bgClass: "bg-scary",
          music: "33.wav",
          speed: null,
        },
        Void: {
          bgClass: "bg-void",
          music: null,
          speed: 0.0,
        },
      };

      function getSpeedScale() {
        const baseWidth = 1920;
        const minScale = 0.4;
        const maxScale = 1.0;
        const currentWidth = window.innerWidth;
        return Math.min(Math.max(currentWidth / baseWidth, minScale), maxScale);
      }
      let previousScale = getSpeedScale();

      /* ======================================================
       2. Environment Selection
      ====================================================== */
      document.getElementById("envActionBtn").addEventListener("click", () =>
        pickEnvironment("Action")
      );
      document.getElementById("envCalmBtn").addEventListener("click", () =>
        pickEnvironment("Calm")
      );
      document.getElementById("envScaryBtn").addEventListener("click", () =>
        pickEnvironment("Scary")
      );
      document.getElementById("envVoidBtn").addEventListener("click", () =>
        pickEnvironment("Void")
      );

      let speedIntervalId = null;
      async function pickEnvironment(envKey) {
        const env = environments[envKey];
        if (!env) return;

        // 1. Stop current background audio and clear dynamic elements
        stopCurrentBG();

        // 2. Remove all environment classes and add the new one
        Object.values(environments).forEach((e) =>
          document.body.classList.remove(e.bgClass)
        );
        document.body.classList.add(env.bgClass);

        // 3. Play background music if available
        if (env.music) {
          currentBgAudio = new Audio(env.music);
          currentBgAudio.loop = true;
          currentBgAudio.volume = 0.5;
          currentBgAudio.muted = muted;
          currentBgAudio.setAttribute("playsinline", "");
          try {
            await currentBgAudio.play();
          } catch (err) {
            console.warn("Audio play blocked:", err);
          }
        } else {
          currentBgAudio = null;
        }

        // 4. Initialize Web Audio for bounce SFX if not done already
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          loadBounceSFX();
        }

        // 5. Hide the environment overlay
        hideEnvironmentOverlay();

        // 6. Add dynamic elements specific to the environment
        addDynamicElements(envKey);

        // 7. Adjust speed based on environment
        if (envKey === "Scary") {
          startScarySpeedChanges();
        } else {
          if (speedIntervalId) {
            clearInterval(speedIntervalId);
            speedIntervalId = null;
          }
          setEnvironmentSpeed(env.speed);
        }
      }

      function stopCurrentBG() {
        if (currentBgAudio) {
          currentBgAudio.pause();
          currentBgAudio.src = "";
          currentBgAudio = null;
        }
        removeDynamicElements();
        if (speedIntervalId) {
          clearInterval(speedIntervalId);
          speedIntervalId = null;
        }
      }

      function hideEnvironmentOverlay() {
        const overlay = document.getElementById("audioChoiceOverlay");
        if (overlay) {
          overlay.classList.add("hidden");
          setTimeout(() => {
            overlay.style.display = "none";
          }, 500);
        }
      }

      /* Pre-fetch and decode bounce SFX into AudioBuffers */
      async function loadBounceSFX() {
        const buffers = [];
        for (const url of bounceSFX) {
          try {
            const resp = await fetch(url);
            const arrayBuf = await resp.arrayBuffer();
            const audioBuf = await audioCtx.decodeAudioData(arrayBuf);
            buffers.push(audioBuf);
          } catch (e) {
            console.warn("Error decoding bounce SFX:", url, e);
          }
        }
        bounceBuffers = buffers;
      }

      /* ======================================================
       3. "Change Environment" Button
      ====================================================== */
      document.getElementById("changeEnvBtn").addEventListener("click", () => {
        showEnvironmentOverlay();
      });
      function showEnvironmentOverlay() {
        const overlay = document.getElementById("audioChoiceOverlay");
        if (overlay) {
          overlay.style.display = "flex";
          overlay.classList.remove("hidden");
        }
      }

      /* ======================================================
       4. Mute / Unmute Functionality
      ====================================================== */
      document.getElementById("muteBtn").addEventListener("click", () => {
        muted = !muted;
        if (currentBgAudio) {
          currentBgAudio.muted = muted;
        }
        updateMuteUI();
      });
      function updateMuteUI() {
        const muteIcon = document.getElementById("muteIcon");
        const muteLabel = document.getElementById("muteLabel");
        if (muted) {
          muteIcon.textContent = "ðŸ”‡";
          muteLabel.textContent = "Unmute";
        } else {
          muteIcon.textContent = "ðŸ”Š";
          muteLabel.textContent = "Mute";
        }
      }

      /* ======================================================
       5. Dynamic Speed Adjustment Based on Environment
      ====================================================== */
      function setEnvironmentSpeed(envSpeed) {
        const scale = getSpeedScale();
        velocity.set(envSpeed * scale, envSpeed * scale);
      }
      function startScarySpeedChanges() {
        if (speedIntervalId) clearInterval(speedIntervalId);
        setRandomVelocity();
        speedIntervalId = setInterval(setRandomVelocity, 200);
      }
      function setRandomVelocity() {
        const minSpeed = -1.0,
          maxSpeed = 1.0;
        const randomX = Math.random() * (maxSpeed - minSpeed) + minSpeed;
        const randomY = Math.random() * (maxSpeed - minSpeed) + minSpeed;
        const scale = getSpeedScale();
        velocity.set(randomX * scale, randomY * scale);
      }

      const clock = new THREE.Clock();
      let currentModelIndex = -1;
      const animationPaths = [
        "BreakdanceFootworkToIdle.fbx",
        "Capoeira.fbx",
        "JoyfulJump.fbx",
        "DancingTwerk.fbx",
        "Shuffling.fbx",
        "SillyDancing.fbx",
        "Spinning.fbx",
        "SittingDisbelief.fbx",
        "Flair.fbx",
        "WaveHipHopDance.fbx",
        "HipHopDancing.fbx",
      ];

      /* ======================================================
       6. Three.js Setup and FBX Model Loading
      ====================================================== */
      let currentModelColor = new THREE.Color(0xffffff);
      const textureLoader = new THREE.TextureLoader();
      const texture = textureLoader.load("t1.png");
      function applyTextureToModel(model, texture) {
        model.traverse((child) => {
          if (child.isMesh) {
            const newMaterial = new THREE.MeshStandardMaterial({
              map: texture,
              skinning: true,
              morphTargets: true,
              morphNormals: true,
              wireframe: child.material?.wireframe || false,
              transparent: child.material?.transparent || false,
              opacity: child.material?.opacity || 1,
            });
            child.material = newMaterial;
          }
        });
      }

      function loadRandomFBX(previousPosition = null) {
        let newIndex;
        do {
          newIndex = Math.floor(Math.random() * animationPaths.length);
        } while (newIndex === currentModelIndex && animationPaths.length > 1);
        currentModelIndex = newIndex;
        const modelPath = animationPaths[currentModelIndex];
        const loader = new THREE.FBXLoader();
        loader.load(
          modelPath,
          (fbx) => {
            if (model) {
              if (!previousPosition) previousPosition = model.position.clone();
              // Clean up old model
              scene.remove(model);
              model.traverse((child) => {
                if (child.isMesh) {
                  child.geometry.dispose();
                  child.material.dispose();
                }
              });
            }
            model = fbx;
            model.scale.set(1, 1, 1);
            if (previousPosition) {
              model.position.copy(previousPosition);
            } else {
              model.position.set(0, 0, 0);
            }
            if (mixer) {
              mixer.stopAllAction();
              mixer.uncacheRoot(mixer.getRoot());
            }
            mixer = new THREE.AnimationMixer(model);
            if (fbx.animations && fbx.animations.length > 0) {
              fbx.animations.forEach((clip) => {
                mixer.clipAction(clip).play();
              });
            } else {
              console.warn("No animations found in the FBX model:", modelPath);
            }
            applyTextureToModel(model, texture);
            scene.add(model);
          },
          (xhr) => {
            console.log(
              `${modelPath}: ${((xhr.loaded / xhr.total) * 100).toFixed(1)}% loaded`
            );
          },
          (error) => {
            console.error("Error loading FBX model:", error);
          }
        );
      }

      initThree();
      animate();

      function initThree() {
        scene = new THREE.Scene();
        const w = window.innerWidth;
        const h = window.innerHeight;
        const aspect = w / h;
        camera = new THREE.OrthographicCamera(
          -BASE_HALF_HEIGHT * aspect,
          BASE_HALF_HEIGHT * aspect,
          BASE_HALF_HEIGHT,
          -BASE_HALF_HEIGHT,
          1,
          1000
        );
        camera.position.set(0, 0, 100);
        camera.lookAt(0, 0, 0);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setClearColor(0x000000, 0);
        renderer.setSize(w, h);
        document.getElementById("container").appendChild(renderer.domElement);

        loadRandomFBX();

        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 1);
        directional.position.set(1, 2, 3);
        scene.add(directional);

        window.addEventListener("resize", onWindowResize);
      }

      function onWindowResize() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        renderer.setSize(w, h);
        const aspect = w / h;
        camera.left = -BASE_HALF_HEIGHT * aspect;
        camera.right = BASE_HALF_HEIGHT * aspect;
        camera.top = BASE_HALF_HEIGHT;
        camera.bottom = -BASE_HALF_HEIGHT;
        camera.updateProjectionMatrix();
        adjustCurrentVelocityScale();
      }

      function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if (mixer) mixer.update(delta);
        if (model) {
          model.position.x += velocity.x;
          model.position.y += velocity.y;
          const { halfW, halfH } = getCurrentBounceBox();
          let bounced = false;
          if (model.position.x > halfW) {
            model.position.x = halfW;
            velocity.x *= -1;
            bounced = true;
          } else if (model.position.x < -halfW) {
            model.position.x = -halfW;
            velocity.x *= -1;
            bounced = true;
          }
          if (model.position.y > halfH) {
            model.position.y = halfH;
            velocity.y *= -1;
            bounced = true;
          } else if (model.position.y < -halfH) {
            model.position.y = -halfH;
            velocity.y *= -1;
            bounced = true;
          }
          if (bounced) onBounce();
        }
        renderer.render(scene, camera);
      }

      function getCurrentBounceBox() {
        const halfH = BASE_HALF_HEIGHT / camera.zoom - MODEL_RADIUS;
        const halfW = halfH * (window.innerWidth / window.innerHeight);
        return { halfW, halfH };
      }

      function onBounce() {
        // (Color-change effect removed for clarity)
        playBounceSound();
      }

      function playBounceSound() {
        if (muted || !audioCtx || bounceBuffers.length === 0) return;
        const index = Math.floor(Math.random() * bounceBuffers.length);
        const buf = bounceBuffers[index];
        if (!buf) return;
        const source = audioCtx.createBufferSource();
        source.buffer = buf;
        source.connect(audioCtx.destination);
        source.start(0);
      }

      /* ======================================================
       7. Dynamic Elements Management
      ====================================================== */
      let dynamicElements = [];
      function addDynamicElements(envKey) {
        switch (envKey) {
          case "Action":
            addActionParticles();
            break;
          case "Calm":
            addCalmClouds();
            break;
          case "Scary":
            addScaryShadows();
            addEerieMist();
            break;
          case "Void":
            addShootingStars();
            break;
          default:
            break;
        }
      }
      function removeDynamicElements() {
        dynamicElements.forEach((el) => el.remove());
        dynamicElements = [];
      }

      function addActionParticles() {
        const bgAction = document.querySelector(".bg-action");
        if (!bgAction) return;
        // Add an extra fire layer element
        const fireLayer = document.createElement("div");
        fireLayer.classList.add("fire-layer");
        bgAction.appendChild(fireLayer);
        dynamicElements.push(fireLayer);
        // Create particles
        for (let i = 0; i < 30; i++) {
          const particle = document.createElement("div");
          particle.classList.add("particle");
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.top = `${Math.random() * 100}%`;
          particle.style.setProperty(
            "--translate-x",
            `${Math.random() * 500 - 250}px`
          );
          particle.style.setProperty(
            "--translate-y",
            `${-(Math.random() * 500)}px`
          );
          particle.style.animationDelay = `${Math.random() * 5}s`;
          particle.style.animationDuration = `${2 + Math.random() * 3}s`;
          bgAction.appendChild(particle);
          dynamicElements.push(particle);
        }
        // Add glow effect
        const glow = document.createElement("div");
        glow.classList.add("glow");
        bgAction.appendChild(glow);
        dynamicElements.push(glow);
      }

      function addCalmClouds() {
        const bgCalm = document.querySelector(".bg-calm");
        if (!bgCalm) return;
        const clouds = document.createElement("div");
        clouds.classList.add("clouds");
        bgCalm.appendChild(clouds);
        dynamicElements.push(clouds);
      }

      function addScaryShadows() {
        const bgScary = document.querySelector(".bg-scary");
        if (!bgScary) return;
        for (let i = 0; i < 8; i++) {
          const shadow = document.createElement("div");
          shadow.classList.add("shadow");
          shadow.style.left = `${Math.random() * 100}%`;
          shadow.style.top = `${Math.random() * 100}%`;
          shadow.style.animationDuration = `${8 + Math.random() * 12}s`;
          bgScary.appendChild(shadow);
          dynamicElements.push(shadow);
        }
      }

      function addShootingStars() {
        const bgVoid = document.querySelector(".bg-void");
        if (!bgVoid) return;
        for (let i = 0; i < 5; i++) {
          const shootingStar = document.createElement("div");
          shootingStar.classList.add("shooting-star");
          shootingStar.style.left = `${Math.random() * 100}%`;
          shootingStar.style.animationDelay = `${Math.random() * 15}s`;
          shootingStar.style.animationDuration = `7s`;
          bgVoid.appendChild(shootingStar);
          dynamicElements.push(shootingStar);
        }
      }

      function addEerieMist() {
        const bgScary = document.querySelector(".bg-scary");
        if (!bgScary) return;
        const mist = document.createElement("div");
        mist.classList.add("eerie-mist");
        bgScary.appendChild(mist);
        dynamicElements.push(mist);
      }

      function adjustCurrentVelocityScale() {
        const scale = getSpeedScale();
        velocity.set(
          (velocity.x / previousScale) * scale,
          (velocity.y / previousScale) * scale
        );
        previousScale = scale;
      }

      /* ======================================================
       8. Initialize on DOMContentLoaded
      ====================================================== */
      document.addEventListener("DOMContentLoaded", () => {
        // Set a default environment and initialize the change FBX button listener
        pickEnvironment("Void");
        const changeFbxBtn = document.getElementById("changeFbxBtn");
        if (changeFbxBtn) {
          changeFbxBtn.addEventListener("click", () => {
            if (model) {
              const currentPosition = model.position.clone();
              loadRandomFBX(currentPosition);
            } else {
              loadRandomFBX();
            }
          });
        }
      });
    </script>
  </body>
</html>